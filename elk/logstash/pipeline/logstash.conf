input {
  # File input for application logs
  file {
    path => "/var/log/ecommerce-store/*.log"
    start_position => "beginning"
    codec => "json"
    type => "application"
  }
  
  # TCP input for direct log streaming
  tcp {
    port => 5000
    codec => "json"
    type => "tcp"
  }
  
  # UDP input for syslog
  udp {
    port => 5000
    codec => "json"
    type => "udp"
  }
}

filter {
  if [type] == "application" {
    # Parse timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
    
    # Add application name
    mutate {
      add_field => { "application" => "ecommerce-store" }
    }
    
    # Parse log level
    if [level] {
      mutate {
        add_field => { "log_level" => "%{level}" }
      }
    }
    
    # Parse logger name
    if [logger_name] {
      mutate {
        add_field => { "logger" => "%{logger_name}" }
      }
    }
    
    # Parse thread name
    if [thread_name] {
      mutate {
        add_field => { "thread" => "%{thread_name}" }
      }
    }
    
    # Parse message
    if [message] {
      mutate {
        add_field => { "log_message" => "%{message}" }
      }
    }
    
    # Add environment tag
    mutate {
      add_field => { "environment" => "development" }
    }
  }
  
  if [type] == "tcp" or [type] == "udp" {
    # Parse timestamp if present
    if [timestamp] {
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }
    
    # Add application name
    mutate {
      add_field => { "application" => "ecommerce-store" }
    }
    
    # Add environment tag
    mutate {
      add_field => { "environment" => "development" }
    }
  }
  
  # Remove fields that are not needed
  mutate {
    remove_field => [ "host", "path", "@version" ]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ecommerce-store-%{+YYYY.MM.dd}"
    document_type => "%{type}"
    template_name => "ecommerce-store"
    template => {
      "index_patterns" => ["ecommerce-store-*"]
      "settings" => {
        "number_of_shards" => 1
        "number_of_replicas" => 0
      }
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" }
          "application" => { "type" => "keyword" }
          "environment" => { "type" => "keyword" }
          "log_level" => { "type" => "keyword" }
          "logger" => { "type" => "keyword" }
          "thread" => { "type" => "keyword" }
          "log_message" => { "type" => "text" }
          "type" => { "type" => "keyword" }
        }
      }
    }
  }
  
  # Output to console for debugging
  stdout {
    codec => "rubydebug"
  }
}
